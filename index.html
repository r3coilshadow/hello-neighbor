<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hello Neighbor - 2 Player (One Life)</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; margin: auto; background: #84b6f4; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// Sounds
const jumpSound = new Audio("https://cdn.pixabay.com/audio/2021/08/04/audio_918b521f7d.mp3");
const keySound = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2d922da94d.mp3");
const hitSound = new Audio("https://cdn.pixabay.com/audio/2022/03/10/audio_3f1d13dccc.mp3");

function createPlayer(x, y, color, controls) {
  return {
    x, y,
    width: 40, height: 40,
    color,
    vx: 0, vy: 0,
    onGround: false,
    health: 1,
    hasKey: false,
    eliminated: false,
    controls
  };
}

const player1 = createPlayer(100, 500, "orange", { left: "a", right: "d", up: "w" });
const player2 = createPlayer(140, 500, "lime", { left: "ArrowLeft", right: "ArrowRight", up: "ArrowUp" });

const gravity = 0.8, friction = 0.8, speed = 4, jump = -14;

let level = 0;
const levels = [
  {
    platforms: [
      { x: 0, y: 580, width: 800, height: 20 },
      { x: 150, y: 500, width: 120, height: 20 },
      { x: 300, y: 420, width: 120, height: 20 },
      { x: 450, y: 340, width: 120, height: 20 },
      { x: 600, y: 260, width: 120, height: 20 },
    ],
    key: { x: 620, y: 230, width: 20, height: 20, collected: false },
    door: { x: 760, y: 560, width: 30, height: 20, locked: true },
    goal: { x: 380, y: 0, width: 40, height: 20 }
  },
];

const neighbor = { x: 700, y: 500, width: 40, height: 40, color: "red", speed: 1.2 };

function draw(obj, color) {
  ctx.fillStyle = color || obj.color;
  ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
}

function checkCollision(a, b) {
  return a.x < b.x + b.width &&
         a.x + a.width > b.x &&
         a.y < b.y + b.height &&
         a.y + a.height > b.y;
}

function applyPhysics(p, platforms) {
  if (p.eliminated) return;

  if (keys[p.controls.left]) p.vx = -speed;
  else if (keys[p.controls.right]) p.vx = speed;
  else p.vx *= friction;

  if (keys[p.controls.up] && p.onGround) {
    p.vy = jump;
    p.onGround = false;
    jumpSound.play();
  }

  p.vy += gravity;
  p.x += p.vx;
  p.y += p.vy;

  p.onGround = false;
  for (let plat of platforms) {
    if (checkCollision(p, plat)) {
      if (p.vy > 0 && p.y + p.height - p.vy <= plat.y) {
        p.y = plat.y - p.height;
        p.vy = 0;
        p.onGround = true;
      }
    }
  }

  if (p.y > canvas.height && !p.eliminated) {
    eliminatePlayer(p);
  }
}

function eliminatePlayer(p) {
  p.health = 0;
  p.eliminated = true;
  hitSound.play();
}

function update() {
  const lvl = levels[level];
  const plats = lvl.platforms;

  [player1, player2].forEach(p => applyPhysics(p, plats));

  // Key collection
  [player1, player2].forEach(p => {
    if (!lvl.key.collected && checkCollision(p, lvl.key)) {
      lvl.key.collected = true;
      p.hasKey = true;
      keySound.play();
    }
  });

  // Unlock door
  if (lvl.key.collected) lvl.door.locked = false;

  // Neighbor AI follows closest non-eliminated player
  let target = player1;
  if (player1.eliminated && !player2.eliminated) target = player2;
  if (player2.eliminated && !player1.eliminated) target = player1;

  if (!target.eliminated) {
    if (neighbor.x < target.x) neighbor.x += neighbor.speed;
    if (neighbor.x > target.x) neighbor.x -= neighbor.speed;
    if (neighbor.y < target.y) neighbor.y += neighbor.speed;
    if (neighbor.y > target.y) neighbor.y -= neighbor.speed;

    if (checkCollision(neighbor, target)) {
      eliminatePlayer(target);
    }
  }

  // Both players must reach the goal (at the top) to win
  if (checkCollision(player1, lvl.goal) && checkCollision(player2, lvl.goal) && !player1.eliminated && !player2.eliminated) {
    level = (level + 1) % levels.length;
    resetLevel();
  }
}

function resetLevel() {
  player1.x = 100; player1.y = 500; player1.vx = 0; player1.vy = 0;
  player2.x = 140; player2.y = 500; player2.vx = 0; player2.vy = 0;
  player1.hasKey = false; player2.hasKey = false;
  player1.eliminated = false; player2.eliminated = false;
  player1.health = 1; player2.health = 1;
  const lvl = levels[level];
  lvl.key.collected = false;
  lvl.door.locked = true;
  neighbor.x = 700; neighbor.y = 500;
}

function render() {
  const lvl = levels[level];
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  lvl.platforms.forEach(p => draw(p, "#333"));
  if (!lvl.key.collected) draw(lvl.key, "gold");
  draw(lvl.door, lvl.door.locked ? "brown" : "green");
  draw(lvl.goal, "white");

  if (!player1.eliminated) draw(player1);
  if (!player2.eliminated) draw(player2);
  draw(neighbor);

  ctx.fillStyle = "white";
  ctx.font = "16px Arial";
  ctx.fillText("Level " + (level + 1), 20, 30);

  if (player1.eliminated) ctx.fillText("Player 1 Eliminated", 600, 30);
  if (player2.eliminated) ctx.fillText("Player 2 Eliminated", 600, 50);
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
